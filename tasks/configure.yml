---
# tasks/configure.yml (nginxv3)
# Prefix : nginxv3

- name: "Create directories"
  file:
    path: "{{ item.path }}"
    state: "directory"
    mode: "{{ item.mode | default('0755') }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
  loop: "{{ nginxv3_all_create_directories }}"

- name: "Create dummy ssl"
  include_tasks: "create_dummy_ssl_keys.yml"
  loop_control:
    loop_var: "ssl_conf"
  when: "ssl_conf.value.src_dir is none"
  loop: "{{ nginxv3_merged_ssl_confs | dict2items }}"

- name: "Set nginx.conf"
  template:
    src: "nginx.conf.j2"
    dest: "/etc/nginx/nginx.conf"
    mode: "0644"
  notify: "nginxv3 reload nginx"

- name: "Set vhost for dummy"
  template:
    src: "vhost_dummy.conf.j2"
    dest: "/etc/nginx/conf.d/dummy.conf"
    mode: "0644"
  when: nginxv3_use_dummy_vhost | bool
  notify: "nginxv3 reload nginx"

- name: "Not use dummy.conf"
  file:
    path: "/etc/nginx/conf.d/dummy.conf"
    state: "absent"
  when: not nginxv3_use_dummy_vhost | bool
  notify: "nginxv3 reload nginx"

- name: "Check nginx conf file syntax"
  command: "nginx -t"
  register: _check_nginx_syntax
  changed_when: false
  check_mode: no
  failed_when: "'test failed' in _check_nginx_syntax.stderr"

- name: "nginx start"
  systemd:
    name: "nginx.service"
    enabled: yes
    state: "started"
